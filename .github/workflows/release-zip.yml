name: Build WP release ZIP

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  # Folder name inside the ZIP (should match plugin main folder name)
  PLUGIN_SLUG: mainwp

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set variables
        id: vars
        run: |
          REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
          PLUGIN_DIR="${PLUGIN_SLUG:-$REPO_NAME}"
          TAG="${GITHUB_REF##*/}"
          DIST_DIR="dist"
          ZIP_NAME="${PLUGIN_DIR}.zip"
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "PLUGIN_DIR=${PLUGIN_DIR}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "DIST_DIR=${DIST_DIR}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: Optional build (composer / npm)
        run: |
          set -euo pipefail

          # Composer build
          if [ -f composer.json ]; then
            echo "Installing Composer dependencies..."
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            php composer-setup.php --install-dir=/tmp --filename=composer
            /tmp/composer install --no-dev --optimize-autoloader
            rm -f composer-setup.php
          fi

          # Node build
          if [ -f package.json ]; then
            echo "Installing npm dependencies..."
            npm ci
            if npm run | grep -q ' build'; then
              echo "Running npm build..."
              npm run build || true
            fi
          fi

      - name: Prepare dist folder
        run: |
          set -euo pipefail
          PLUGIN_DIR="${{ steps.vars.outputs.PLUGIN_DIR }}"
          rm -rf dist
          mkdir -p dist

          echo "Copying files into dist/${PLUGIN_DIR}/..."
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='dist' \
            --exclude='node_modules' \
            --exclude='*.zip' \
            ./ "dist/${PLUGIN_DIR}/"

      - name: Create ZIP file
        working-directory: dist
        run: |
          set -euo pipefail
          ZIP_NAME="${{ steps.vars.outputs.ZIP_NAME }}"
          PLUGIN_DIR="${{ steps.vars.outputs.PLUGIN_DIR }}"
          zip -r "$ZIP_NAME" "$PLUGIN_DIR"
          echo "Created ZIP: $ZIP_NAME"
          unzip -l "$ZIP_NAME" | head -n 20

      - name: Upload ZIP as release asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ steps.vars.outputs.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
