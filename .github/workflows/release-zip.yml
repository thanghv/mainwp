name: Build WP release ZIP

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  # explicit plugin folder name inside the zip
  PLUGIN_SLUG: mainwp

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set variables
        id: vars
        run: |
          REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
          PLUGIN_DIR="${PLUGIN_SLUG:-$REPO_NAME}"
          TAG="${GITHUB_REF##*/}"
          DIST_DIR="dist"
          ZIP_NAME="${PLUGIN_DIR}.zip"
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "PLUGIN_DIR=${PLUGIN_DIR}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "DIST_DIR=${DIST_DIR}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: Optional build (composer / npm) â€” runs only if files exist
        run: |
          set -euo pipefail
          # Composer: if composer.json exists, install prod dependencies
          if [ -f composer.json ]; then
            php -r "copy('https://getcomposer.org/installer','composer-setup.php');"
            php composer-setup.php --install-dir=/tmp --filename=composer
            /tmp/composer install --no-dev --optimize-autoloader
            rm -f composer-setup.php
          fi

          # NPM: if package.json exists, run npm ci and optional build
          if [ -f package.json ]; then
            # ensure node & npm are available
            node --version || ( echo "Node not found, installing via actions/setup-node" && exit 1 )
            npm ci
            if npm run | grep -q ' build'; then
              npm run build || true
            fi
          fi
        # If you rely on Node sometimes, you can enable setup-node as a separate step;
        # the step above expects node to be present if package.json exists. If you want
        # to ensure Node is installed only when needed, use a separate setup-node step.

      - name: Prepare dist folder and copy repo into plugin-named folder
        run: |
          set -euo pipefail
          PLUGIN_DIR="${{ steps.vars.outputs.PLUGIN_DIR }}"
          rm -rf dist
          mkdir -p dist
          # copy everything (including dotfiles) into dist/<PLUGIN_DIR>
          shopt -s dotglob || true
          cp -R . "dist/${PLUGIN_DIR}/"
          # remove git metadata and workflow files from the packaged folder
          rm -rf "dist/${PLUGIN_DIR}/.git"
          rm -rf "dist/${PLUGIN_DIR}/.github"
          rm -rf "dist/${PLUGIN_DIR}/dist"
          rm -rf "dist/${PLUGIN_DIR}/node_modules"

      - name: Create zip with exact top-level folder name
        working-directory: dist
        run: |
          set -euo pipefail
          ZIP_NAME="${{ steps.vars.outputs.ZIP_NAME }}"
          PLUGIN_DIR="${{ steps.vars.outputs.PLUGIN_DIR }}"
          # Important: zip the folder by name so the top-level entry is exactly "$PLUGIN_DIR/"
          zip -r "$ZIP_NAME" "$PLUGIN_DIR"
          ls -lh "$ZIP_NAME"
          # show list for debugging
          unzip -l "$ZIP_NAME" | sed -n '1,20p'

      - name: Upload ZIP as release asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ steps.vars.outputs.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
